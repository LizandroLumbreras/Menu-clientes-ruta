<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cortes Pendientes</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body{
      margin:0; font-family:'Poppins',sans-serif; background:#f2f4f7; color:#111;
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{ background:#00416A; color:#fff; padding:12px; font-weight:700; font-size:18px; }
    main{ flex:1; padding:14px; display:flex; justify-content:center; }
    .card{ width:100%; max-width:720px; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.15); padding:12px; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background:#00416A; color:#fff; padding:8px; font-size:14px; text-align:left; }
    td{ padding:8px; border-bottom:1px solid #eee; font-size:14px; }
    td:last-child{ text-align:center; }
    .btn{
      border:none; border-radius:8px; padding:6px 12px; cursor:pointer; font-size:14px; font-weight:600; color:#fff;
      background:linear-gradient(180deg,#8a5cff,#5b33cf);
    }
    .btn:hover{ opacity:.9; }
    #hintPendientes{ color:#666; font-size:14px; padding:8px; text-align:center; }

    /* ===== Ticket de impresiÃ³n ===== */
    #ticketArea{ display:none; }
    @media print{
      :root{ --ticket-mm:72; --ticket-pad-mm:1; --ticket-font:18px; --line-height:1.08; }
      @page{ size: calc(var(--ticket-mm) * 1mm) auto; margin:0; }
      html,body{ background:#fff!important; height:auto!important; width:calc(var(--ticket-mm) * 1mm); margin:0!important; padding:0!important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      body *{ visibility:hidden!important; }
      #ticketArea, #ticketArea *{ visibility:visible!important; }
      #ticketArea{ position:fixed; inset:0; display:block!important; background:#fff!important; padding:0; margin:0; z-index:99999; }
      .ticket{ width:calc(var(--ticket-mm) * 1mm); margin:0 auto; padding:0 calc(var(--ticket-pad-mm) * 1mm);
        font:var(--ticket-font)/var(--line-height) 'Poppins',system-ui,sans-serif; color:#000; }
      .ticket .t-header{ text-align:center; margin:2px 0; }
      .ticket hr{ border:none; border-top:1px dashed #999; margin:6px 0; }
      .t-row{ display:flex; justify-content:space-between; gap:6px; margin:2px 0; white-space:nowrap; }
      .t-desc{ flex:1 1 auto; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; }
      .t-imp{ flex:0 0 auto; text-align:right; margin-left:8px; white-space:nowrap; }
      .t-strong{ font-size: calc(var(--ticket-font) + 2px); font-weight:700; }
      .t-core,.t-core *{ font-size: calc(var(--ticket-font) - 3px); }
    }
  </style>
</head>
<body>
  <header>Cortes Pendientes</header>
  <main>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th style="text-align:right;">Tickets</th>
            <th style="text-align:right;">Total</th>
            <th style="text-align:center;">AcciÃ³n</th>
          </tr>
        </thead>
        <tbody id="tbodyPendientes"></tbody>
      </table>
      <div id="hintPendientes" style="display:none;">No hay cortes pendientes ðŸŽ‰</div>
    </div>
  </main>

  <!-- Ticket imprimible (corte) -->
  <div id="ticketArea">
    <div id="ticket" class="ticket">
      <div class="t-header t-strong">La Proveedora</div>
      <div class="t-header t-strong">Ruta de Venta</div>
      <hr>
      <div class="t-header t-core" id="tFolio"></div>
      <div class="t-header t-core" id="tFecha"></div>
      <div class="t-header t-core">AtendiÃ³: <span id="tAtendio"></span></div>
      <div class="t-header t-core" id="tRuta"></div>
      <hr>
      <div class="t-core" id="tLineas"></div>
      <hr>
      <div class="t-core" style="text-align:right;">
        <div class="t-row"><span class="t-desc">Subtotal</span><span class="t-imp" id="tSubtotal"></span></div>
        <div class="t-row"><span class="t-desc">Impuestos</span><span class="t-imp" id="tImpuestos"></span></div>
        <div class="t-row" style="font-weight:700;"><span class="t-desc">Total</span><span class="t-imp" id="tTotal"></span></div>
      </div>
      <hr>
      <div class="t-header t-core" id="tNotas"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, query, where, orderBy, Timestamp, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "TU_APIKEY",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const rutaId   = 'ruta_1';
    const ATENDIO  = 'Juan Serrato';
    const money = (n)=>'$'+(Number(n)||0).toFixed(2);
    const pad2 = n => String(n).padStart(2,'0');
    const toYYYYMMDD = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    function rangoUltimosDias(dias=30){
      const end=new Date(); end.setHours(23,59,59,999);
      const start=new Date(); start.setDate(start.getDate()-(dias-1)); start.setHours(0,0,0,0);
      return {start,end};
    }

    async function calcularResumenDeDia(dateStr){
      const [Y,M,D]=dateStr.split('-').map(Number);
      const start=new Date(Y,M-1,D,0,0,0,0);
      const end=new Date(Y,M-1,D,23,59,59,999);
      const tsStart=Timestamp.fromDate(start), tsEnd=Timestamp.fromDate(end);

      const ventasRef=collection(db,'rutas_venta',rutaId,'ventas');
      const qv=query(ventasRef,where('fecha','>=',tsStart),where('fecha','<',tsEnd),orderBy('fecha','asc'));
      const snap=await getDocs(qv);
      let total=0,conteo=0; const desg={efectivo:0,tarjeta:0,transferencia:0,mixto:0};
      snap.forEach(s=>{
        const v=s.data(), t=Number(v.total||0);
        total+=t; conteo++;
        const m=(v.metodo_pago||'').toLowerCase();
        if(m==='efectivo')desg.efectivo+=t;
        else if(m==='tarjeta')desg.tarjeta+=t;
        else if(m==='transferencia')desg.transferencia+=t;
        else if(m==='mixto')desg.mixto+=t;
      });
      return {total,conteo,desg};
    }

    // ===== IMPRESIÃ“N + GUARDADO del corte (con Facturado / No facturado) =====
    async function generarCorteParaDia(dateStr){
      // Resumen base (mÃ©todos de pago + conteo)
      const { total: totalResumen, conteo, desg } = await calcularResumenDeDia(dateStr);
      if (conteo === 0){ alert("No hay ventas en "+dateStr); return; }

      // Releer ventas del dÃ­a para separar facturado/no facturado y sumar impuestos
      const [Y,M,D]=dateStr.split('-').map(Number);
      const start=new Date(Y,M-1,D,0,0,0,0);
      const end=new Date(Y,M-1,D,23,59,59,999);
      const tsStart=Timestamp.fromDate(start), tsEnd=Timestamp.fromDate(end);

      const ventasRef=collection(db,'rutas_venta',rutaId,'ventas');
      const qv=query(ventasRef,where('fecha','>=',tsStart),where('fecha','<',tsEnd),orderBy('fecha','asc'));
      const snap=await getDocs(qv);

      let totFact=0, impFact=0, totNoFact=0, impNoFact=0;
      snap.forEach(s=>{
        const v=s.data();
        const t   = Number(v.total||0);
        const imp = Number(v.impuestos||0);
        const ocupa = (v.cliente_ocupa_factura !== undefined)
          ? !!v.cliente_ocupa_factura
          : !!(v.cliente_info && v.cliente_info.ocupa_factura);
        if(ocupa){ totFact+=t; impFact+=imp; }
        else     { totNoFact+=t; impNoFact+=imp; }
      });

      const subFact     = +(totFact   - impFact).toFixed(2);
      const subNoFact   = +(totNoFact - impNoFact).toFixed(2);
      const subtotalDia = +(subFact + subNoFact).toFixed(2);
      const impGlobal   = +(impFact + impNoFact).toFixed(2);
      const totGlobal   = +(totFact + totNoFact).toFixed(2); // â‰ˆ totalResumen

// ===== Construir ticket para imprimir =====
const folioCorte = `C-${dateStr.replaceAll('-','')}`;
// Y, M, D ya fueron declarados arriba en esta misma funciÃ³n
const fechaCorte = new Date(Y, M - 1, D);
const fechaTxt = fechaCorte.toLocaleDateString() + ' 23:59';
      document.getElementById('tFolio').textContent   = `CORTE: ${folioCorte}`;
      document.getElementById('tFecha').textContent   = fechaTxt;
      document.getElementById('tAtendio').textContent = ATENDIO;
      document.getElementById('tRuta').textContent    = `Ruta: ${rutaId}`;

      const tLineas=document.getElementById('tLineas');
      tLineas.innerHTML='';

      const mk  = (l,r)=>{const d=document.createElement('div'); d.className='t-row'; d.innerHTML=`<span class="t-desc">${l}</span><span class="t-imp">${money(r)}</span>`; return d;};
      const sep = (t)=>{const d=document.createElement('div'); d.className='t-row'; d.style.fontWeight='700'; d.innerHTML=`<span class="t-desc">â€” ${t} â€”</span><span class="t-imp"></span>`; return d;};

      // FACTURADO
      tLineas.appendChild(sep('FACTURADO'));
      tLineas.appendChild(mk('Subtotal',  subFact));
      tLineas.appendChild(mk('Impuestos', impFact));
      tLineas.appendChild(mk('Total',     totFact));

      // NO FACTURADO
      tLineas.appendChild(sep('NO FACTURADO'));
      tLineas.appendChild(mk('Subtotal',  subNoFact));
      tLineas.appendChild(mk('Impuestos', impNoFact));
      tLineas.appendChild(mk('Total',     totNoFact));

      // MÃ‰TODOS DE PAGO
      tLineas.appendChild(sep('MÃ‰TODOS DE PAGO'));
      tLineas.appendChild(mk('EFECTIVO',    desg.efectivo));
      tLineas.appendChild(mk('TARJETA',     desg.tarjeta));
      tLineas.appendChild(mk('TRANSFER',    desg.transferencia));
      tLineas.appendChild(mk('MIXTO',       desg.mixto));

      // Totales globales
      document.getElementById('tSubtotal').textContent  = money(subtotalDia);
      document.getElementById('tImpuestos').textContent = money(impGlobal);
      document.getElementById('tTotal').textContent     = money(totGlobal);
      document.getElementById('tNotas').textContent     = 'Fin de dÃ­a';

      // Imprimir
      window.print();

      // ===== Guardar en Firestore (mismo doc del corte) =====
      const corteRef=doc(db,'rutas_venta',rutaId,'cortes',dateStr);
      await setDoc(corteRef,{
        fecha_dia: dateStr,
        total: totGlobal,
        subtotal_dia: subtotalDia,
        impuestos_dia: impGlobal,
        tickets: conteo,
        desglose: desg,
        facturado:   { subtotal: subFact,   impuestos: impFact,   total: totFact },
        no_facturado:{ subtotal: subNoFact, impuestos: impNoFact, total: totNoFact },
        atendio: ATENDIO,
        creado: serverTimestamp()
      }, { merge:true });

      alert(`Corte de ${dateStr} registrado e impreso âœ…`);
      listarCortesPendientes();
    }

    async function listarCortesPendientes(){
      const {start,end}=rangoUltimosDias(30);
      const tsStart=Timestamp.fromDate(start), tsEnd=Timestamp.fromDate(end);

      // Agregar por dÃ­a desde ventas
      const ventasRef=collection(db,'rutas_venta',rutaId,'ventas');
      const qv=query(ventasRef,where('fecha','>=',tsStart),where('fecha','<',tsEnd));
      const snapV=await getDocs(qv);
      const porDia=new Map();
      snapV.forEach(s=>{
        const v=s.data();
        const d=v.fecha_dia||toYYYYMMDD((v.fecha&&v.fecha.toDate)?v.fecha.toDate():new Date(v.fecha_txt||Date.now()));
        const t=Number(v.total||0);
        const cur=porDia.get(d)||{total:0,tickets:0};
        cur.total+=t; cur.tickets++; porDia.set(d,cur);
      });

      // DÃ­as ya cerrados
      const cortesRef=collection(db,'rutas_venta',rutaId,'cortes');
      const qc=query(cortesRef,where('fecha_dia','>=',toYYYYMMDD(start)),where('fecha_dia','<=',toYYYYMMDD(end)));
      const snapC=await getDocs(qc);
      const cerrados=new Set(); snapC.forEach(c=>{const x=c.data(); if(x&&x.fecha_dia)cerrados.add(x.fecha_dia);});

      const pendientes=Array.from(porDia.entries()).filter(([d])=>!cerrados.has(d)).sort((a,b)=>a[0]<b[0]?1:-1);

      const tbody=document.getElementById('tbodyPendientes'); tbody.innerHTML='';
      const hint=document.getElementById('hintPendientes');
      if(pendientes.length===0){hint.style.display='block'; return;} hint.style.display='none';

      pendientes.forEach(([fecha_dia,data])=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${fecha_dia}</td>
          <td style="text-align:right;">${data.tickets}</td>
          <td style="text-align:right;">${money(data.total)}</td>
          <td><button class="btn" data-dia="${fecha_dia}">Generar corte</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('.btn').forEach(btn=>{
        btn.addEventListener('click',ev=>generarCorteParaDia(ev.currentTarget.getAttribute('data-dia')));
      });
    }

    // Inicial
    listarCortesPendientes();
  </script>
</body>
</html>



